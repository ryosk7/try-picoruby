var t,e,r,n,i;!function(t){t[t.CTRL_SYNC=0]="CTRL_SYNC",t[t.GET_SECTOR_COUNT=1]="GET_SECTOR_COUNT",t[t.GET_SECTOR_SIZE=2]="GET_SECTOR_SIZE",t[t.GET_BLOCK_SIZE=3]="GET_BLOCK_SIZE",t[t.CTRL_TRIM=4]="CTRL_TRIM"}(t||(t={})),function(t){t[t.FAT=1]="FAT",t[t.FAT32=2]="FAT32",t[t.EXFAT=4]="EXFAT",t[t.ANY=7]="ANY",t[t.SFD=8]="SFD"}(e||(e={})),function(t){t[t.OK=0]="OK",t[t.DISK_ERR=1]="DISK_ERR",t[t.INT_ERR=2]="INT_ERR",t[t.NOT_READY=3]="NOT_READY",t[t.NO_FILE=4]="NO_FILE",t[t.NO_PATH=5]="NO_PATH",t[t.INVALID_NAME=6]="INVALID_NAME",t[t.DENIED=7]="DENIED",t[t.EXIST=8]="EXIST",t[t.INVALID_OBJECT=9]="INVALID_OBJECT",t[t.WRITE_PROTECTED=10]="WRITE_PROTECTED",t[t.INVALID_DRIVE=11]="INVALID_DRIVE",t[t.NOT_ENABLED=12]="NOT_ENABLED",t[t.NO_FILESYSTEM=13]="NO_FILESYSTEM",t[t.MKFS_ABORTED=14]="MKFS_ABORTED",t[t.TIMEOUT=15]="TIMEOUT",t[t.LOCKED=16]="LOCKED",t[t.NOT_ENOUGH_CORE=17]="NOT_ENOUGH_CORE",t[t.TOO_MANY_OPEN_FILES=18]="TOO_MANY_OPEN_FILES",t[t.INVALID_PARAMETER=19]="INVALID_PARAMETER"}(r||(r={})),function(t){t[t.RDO=1]="RDO",t[t.HID=2]="HID",t[t.SYS=4]="SYS",t[t.DIR=16]="DIR",t[t.ARC=32]="ARC"}(n||(n={})),function(t){t[t.READ=1]="READ",t[t.WRITE=2]="WRITE",t[t.OPEN_EXISTING=0]="OPEN_EXISTING",t[t.CREATE_NEW=4]="CREATE_NEW",t[t.CREATE_ALWAYS=8]="CREATE_ALWAYS",t[t.OPEN_ALWAYS=16]="OPEN_ALWAYS",t[t.OPEN_APPEND=48]="OPEN_APPEND"}(i||(i={}));const s=24,o=new URL(new URL("assets/ff_multi-DauRTzqn.wasm",import.meta.url).href,import.meta.url),c=new URL(new URL("assets/ff_single-BRr2adYw.wasm",import.meta.url).href,import.meta.url);function a(t,e,n){const i=e();if(i!==r.OK)throw n?.(),new u(t,i)}class l{#t;#e;constructor(t,e){this.#t=t,this.#e=e}get ptr(){return this.#t}get cSize(){return this.#e.view.getUint16(this.#t+10,!0)}}class h{#r;#n;constructor(t,e){this.#r=t,this.#n=e}get heap(){return new Uint8Array(this.#r.buffer)}get view(){return new DataView(this.#r.buffer)}allocString(t){if(null==t)return 0;const e=(new TextEncoder).encode(t),r=this.alloc(e.length+1),n=this.heap.subarray(r,r+e.length+1);return n.set(e),n[n.length-1]=0,r}alloc(t){return this.#n.malloc(t)}free(t){this.#n.free(t)}decodeString(t,e){const r=this.heap.subarray(t,t+e),n=r.indexOf(0),i=n>=0?r.subarray(0,n):r;return(new TextDecoder).decode(i)}enterScope(t){const e=[],r={alloc:t=>{const r=this.alloc(t);return e.unshift(r),r},allocString:t=>{const r=this.allocString(t);return e.unshift(r),r}};try{return t(r)}finally{for(const t of e)this.free(t)}}}class f{size;date;attrib;name;constructor(t,e,r,n){this.size=t,this.date=e,this.attrib=r,this.name=n}static fromFilInfo(t){const e=new DataView(t.buffer,t.byteOffset,t.byteLength),r=e.getUint32(0,!0),n=e.getUint16(4,!0),i=1980+((65024&n)>>9),s=((480&n)>>5)-1,o=31&n,c=e.getUint16(6,!0),a=new Date(i,s,o,(63488&c)>>11,(2016&c)>>5,2*(31&c)),l=t[8],h=t.subarray(9,22),u=h.indexOf(0),x=u>=0?h.subarray(0,u):h,p=(new TextDecoder).decode(x);return new f(r,a,l,p)}get isReadOnly(){return!!(this.attrib&n.RDO)}get isDirectory(){return!!(this.attrib&n.DIR)}get isHidden(){return!!(this.attrib&n.HID)}get isArchive(){return!!(this.attrib&n.ARC)}get isSystem(){return!!(this.attrib&n.SYS)}}class u extends Error{result;constructor(t,e){super(`Error ${t}: ${r[e]} (${e})`),Object.setPrototypeOf(this,u.prototype),this.result=e}}class x{#i;#n;#e;constructor(t,e,r){this.#i=t,this.#n=e,this.#e=r}get fp(){return this.#i}read(t,e){const r=this.#n.f_read,n=this.#i,i=e??t.length;return this.#e.enterScope((e=>{const s=e.alloc(i),o=e.alloc(4);a("reading file",(()=>r(n,s,i,o)));const c=this.#e.view.getUint32(o,!0);return t.set(this.#e.heap.subarray(s,s+c)),c}))}write(t,e){return this.#e.enterScope((r=>{const n=e??t.length,i=r.alloc(n),s=r.alloc(4);return this.#e.heap.subarray(i,i+n).set(t),a("writing file",(()=>this.#n.f_write(this.#i,i,n,s))),this.#e.view.getUint32(s,!0)}))}close(){try{a("closing file",(()=>this.#n.f_close(this.#i)))}finally{this.#n.free(this.#i)}}sync(){a("syncing disk",(()=>this.#n.f_sync(this.#i)))}lseek(t){a("seeking",(()=>this.#n.f_lseek(this.#i,t)))}rewind(){this.lseek(0)}truncate(){a("truncating file",(()=>this.#n.f_truncate(this.#i)))}expand(t,e){a("expanding file",(()=>this.#n.f_expand(this.#i,t,e)))}gets(t){return this.#e.enterScope((e=>{const r=e.alloc(t+1);return a("reading string from file",(()=>this.#n.f_gets(r,t,this.#i))),this.#e.decodeString(r,t+1)}))}putc(t){const e=t%256;return this.#n.f_putc(e,this.#i)}puts(t){const e=this.#n.f_puts;return this.#e.enterScope((r=>{const n=r.allocString(t);return e(n,this.#i)}))}tell(){return this.#n.f_tell(this.#i)}eof(t){return this.#n.f_eof(this.#i)}size(){return this.#n.f_size(this.#i)}error(t){return this.#n.f_error(this.#i)}}class p{#s;#n;#e;constructor(t,e,r){this.#s=t,this.#n=e,this.#e=r}get dp(){return this.#s}close(){a("closing directory",(()=>this.#n.f_closedir(this.#s))),this.#e.free(this.#s)}read(){return this.#e.enterScope((t=>{const e=t.alloc(s);a("reading directory",(()=>this.#n.f_readdir(this.#s,e)));const r=this.#e.heap.subarray(e,e+s);return f.fromFilInfo(r)}))}rewind(){a("rewinding directory",(()=>this.#n.f_readdir(this.#s,0)))}findNext(){return this.#e.enterScope((t=>{const e=t.alloc(s);a("searching directory for next match",(()=>this.#n.f_findnext(this.#s,e)));const r=this.#e.heap.subarray(e,e+s);return f.fromFilInfo(r)}))}*[Symbol.iterator](){let t;for(this.rewind();""!==(t=this.read()).name;)yield t}}const g={multiPartition:!1,sectorSize:512};class _{#e;#n;static async create(e,n){const i=new WebAssembly.Memory({initial:8}),s={...g,...n??{}},a=function(e,n,i){const s=0|(i??512),o=n.byteLength/s|0;return{env:{memory:e,disk_initialize:t=>r.OK,disk_status:t=>r.OK,disk_read:(t,i,o,c)=>{const a=n.subarray(o*s,(o+c)*s);return new Uint8Array(e.buffer).set(a,i),r.OK},disk_write:(t,i,o,c)=>{const a=new Uint8Array(e.buffer).subarray(i,i+c*s);return n.set(a,o*s),r.OK},disk_ioctl:(n,i,c)=>{const a=new DataView(e.buffer);switch(i){case t.CTRL_SYNC:break;case t.GET_SECTOR_SIZE:a.setUint16(c,s,!0);break;case t.GET_SECTOR_COUNT:a.setUint32(c,o,!0);break;case t.GET_BLOCK_SIZE:return 1;case t.CTRL_TRIM:}return r.OK},get_fattime:()=>{const t=new Date;return(t.getFullYear()-1980)%128<<25|t.getMonth()+1<<21|t.getDay()<<16|t.getHours()<<11|t.getMinutes()<<5|t.getSeconds()>>1}}}}(i,e,s.sectorSize),l=await async function(t,e){const r=e?.multiPartition?o:c;if("undefined"!=typeof window)return await WebAssembly.instantiateStreaming(fetch(r),t);{const{readFile:e}=await import("node:fs/promises"),{fileURLToPath:n}=await import("node:url"),i=await e(n(r));return await WebAssembly.instantiate(i,t)}}(a,s),f=l.instance.exports,u=new h(i,f);return s.multiPartition?new d(u,f):new _(u,f)}constructor(t,e){this.#e=t,this.#n=e}mkfs(t){this.#e.enterScope((e=>{const r=e.allocString(t?.path??"");let n=0;if(null!=t){n=e.alloc(16);const r=this.#e.view;r.setUint8(n,t?.fmt??0),r.setUint8(n+1,t?.nFat??0),r.setUint32(n+2,t?.align??0,!0),r.setUint32(n+6,t?.nRoot??0,!0),r.setUint32(n+10,t?.auSize??0,!0)}const i=e.alloc(4096);a("formatting disk",(()=>this.#n.f_mkfs(r,n,i,4096)))}))}mount(t,e){const r=t=>this.#e.alloc(t);return this.#e.enterScope((n=>{const i=r(560);for(let t=0;t<560;t++)this.#e.heap[i+t]=0;const s=n.allocString(t??"");return a("mounting workspace",(()=>this.#n.f_mount(i,s,e??0)),(()=>this.#e.free(i))),new l(i,this.#e)}))}unmount(t){return this.#e.enterScope((e=>{try{const r=e.allocString(t??"");a("unmounting workspace",(()=>this.#n.f_mount(0,r,0)))}finally{}}))}open(t,e){return this.#e.enterScope((r=>{const n=r.allocString(t),i=this.#e.alloc(576);return a("opening file",(()=>this.#n.f_open(i,n,e)),(()=>this.#e.free(i))),new x(i,this.#n,this.#e)}))}session(t,e=""){this.mount(e);try{return t()}finally{this.unmount(e)}}readFile(t){const e=this.stat(t),r=new Uint8Array(e.size),n=this.open(t,i.READ);try{return n.read(r),r}finally{n.close()}}writeFile(t,e){const r=this.open(t,i.WRITE|i.OPEN_ALWAYS);try{r.write(e)}finally{r.close()}}openDir(t){return this.#e.enterScope((e=>{const r=e.allocString(t),n=this.#e.alloc(64);return a("opening directory",(()=>this.#n.f_opendir(n,r)),(()=>this.#e.free(n))),new p(n,this.#n,this.#e)}))}findFirst(t,e){return this.#e.enterScope((r=>{const n=r.allocString(t),i=r.allocString(e),o=r.alloc(s),c=this.#e.alloc(64);a("searching directory",(()=>this.#n.f_findfirst(c,o,n,i)));const l=this.#e.heap.subarray(o,o+s);return[new p(c,this.#n,this.#e),f.fromFilInfo(l)]}))}*find(t,e){let r,n;for([r,n]=this.findFirst(t,e);""!==n.name;)yield n,n=r.findNext()}stat(t){return this.#e.enterScope((e=>{const r=e.allocString(t),n=e.alloc(s);a("getting file information",(()=>this.#n.f_stat(r,n)));const i=this.#e.heap.subarray(n,n+s);return f.fromFilInfo(i)}))}unlink(t){this.#e.enterScope((e=>{const r=e.allocString(t);a("deleting file or directory",(()=>this.#n.f_unlink(r)))}))}rename(t,e){this.#e.enterScope((r=>{const n=r.allocString(t),i=r.allocString(e);a("renaming file or directory",(()=>this.#n.f_rename(n,i)))}))}chmod(t,e,r){this.#e.enterScope((n=>{const i=n.allocString(t);a("changing file or directory permissions",(()=>this.#n.f_chmod(i,e,r)))}))}utime(t,e){this.#e.enterScope((r=>{const n=r.allocString(t),i=r.alloc(24),s=(e.getFullYear()-1980&127)<<9|e.getMonth()+1<<5|e.getDay();this.#e.view.setUint16(i+4,s,!0);const o=e.getHours()<<11|e.getMinutes()<<5|e.getSeconds()>>>1;this.#e.view.setUint16(i+6,o,!0),a("changing timestamp of file or directory",(()=>this.#n.f_utime(n,i)))}))}mkdir(t){this.#n.f_mkdir,this.#e.enterScope((e=>{const r=e.allocString(t);a("creating directory",(()=>this.#n.f_mkdir(r)))}))}chdir(t){this.#e.enterScope((e=>{const r=e.allocString(t);a("changing current directory",(()=>this.#n.f_chdir(r)))}))}chdrive(t){this.#e.enterScope((e=>{const r=e.allocString(t);a("changing current drive",(()=>this.#n.f_chdrive(r)))}))}getcwd(){return this.#e.enterScope((t=>{const e=t.alloc(260);return a("getting current directory",(()=>this.#n.f_getcwd(e,260))),this.#e.decodeString(e,260)}))}getFree(t){return this.#e.enterScope((e=>{const r=e.allocString(t??""),n=e.alloc(4),i=e.alloc(4);return a("getting free space on drive",(()=>this.#n.f_getfree(r,n,i))),[this.#e.view.getUint32(n,!0),new l(i,this.#e)]}))}getLabel(t){return this.#e.enterScope((e=>{const r=e.allocString(t??""),n=e.alloc(13);this.#e.heap[n+12]=0;const i=e.alloc(4);return a("getting volume label",(()=>this.#n.f_getlabel(r,n,i))),[this.#e.decodeString(n,13),this.#e.view.getUint32(i,!0)]}))}setLabel(t){this.#e.enterScope((e=>{const r=e.allocString(t);a("setting volume label",(()=>this.#n.f_setlabel(r)))}))}setCP(t){const e=this.#n.f_setcp;a("setting active code page",(()=>e(t)))}}class d extends _{#e;#n;constructor(t,e){super(t,e),this.#e=t,this.#n=e}fdisk(t,e){this.#e.enterScope((r=>{const n=r.alloc(512),i=r.alloc(4*t.length);for(let e=0;e<t.length;e++)this.#e.view.setUint32(i+4*e,t[e]);a("partitioning disk",(()=>this.#n.f_fdisk(e??0,i,n)))}))}}export{n as FatFsAttrib,p as FatFsDir,_ as FatFsDisk,d as FatFsDiskPartitionable,u as FatFsError,x as FatFsFile,f as FatFsFileInfo,e as FatFsFormat,t as FatFsIoctl,i as FatFsMode,r as FatFsResult};
//# sourceMappingURL=fatfs.min.mjs.map
